<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Coupons — List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Backend API base defaults to localhost in api.js; add a meta tag only when tunneling -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">CP</div>
        <div>
          <div class="title">Coupon List</div>
          <div class="subtitle">All coupons stored in the system</div>
        </div>
      </div>
      <div class="right">
        <div class="user-chip">
          <div class="avatar" id="userAvatar">CP</div>
          <div class="col">
            <strong id="currentUserName">Admin</strong>
            <span id="currentUserEmail" class="hint" style="font-size:12px;"></span>
          </div>
        </div>
        <button id="logoutBtn" class="btn btn-ghost small" type="button">Logout</button>
        <a class="btn btn-ghost small" href="create-coupon.html">Create Coupon</a>
        <a class="btn btn-ghost small" href="apply-coupon.html">Test Apply</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3 style="margin-top:0">Coupons</h3>
        <div id="msg"></div>
        <div style="overflow:auto">
          <table class="table" id="couponsTable">
            <thead>
              <tr>
                <th>Code</th>
                <th>Type</th>
                <th>Value</th>
                <th>Validity</th>
                <th>Eligibility</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="couponsBody">
              <!-- rows injected by JS -->
            </tbody>
          </table>
        </div>
        <p class="note">Use "Mark Used" to simulate a user consuming the coupon (for testing usage limits).</p>
      </div>

      <div class="card">
        <h3 style="margin-top:0">Quick Tips</h3>
        <ul>
          <li class="hint">If the table is empty, create a coupon first from the Create page.</li>
          <li class="hint">Dates are shown in your browser's locale.</li>
          <li class="hint">Eligibility is stored as JSON; you can copy-paste to edit when creating new coupons.</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="auth.js"></script>
  <script src="api.js"></script>
  <script>
    window.authStore.requireAuth('index.html');
    const currentUser = window.authStore.getCurrentUser();
    if (currentUser) {
      document.getElementById('currentUserName').textContent = currentUser.name || 'Authenticated user';
      document.getElementById('currentUserEmail').textContent = currentUser.email || '';
      document.getElementById('userAvatar').textContent = (currentUser.name || currentUser.email || 'CP').slice(0, 2).toUpperCase();
    }
    document.getElementById('logoutBtn').addEventListener('click', () => {
      window.authStore.logout();
      window.location.href = 'index.html';
    });

    // list-coupons.js (inline)
    const body = document.getElementById('couponsBody');
    const msg = document.getElementById('msg');

    function showMsg(type, text) {
      msg.innerHTML = '';
      const el = document.createElement('div');
      el.className = `message ${type==='error' ? 'error':'success'}`;
      el.textContent = text;
      msg.appendChild(el);
      setTimeout(() => { msg.innerHTML = ''; }, 3000);
    }

    // Render a coupon row
    function renderRow(c) {
      const tr = document.createElement('tr');

      // Code
      const tdCode = document.createElement('td'); tdCode.textContent = c.code; tr.appendChild(tdCode);

      // Type
      const tdType = document.createElement('td'); tdType.textContent = c.discount_type; tr.appendChild(tdType);

      // Value
      const tdVal = document.createElement('td');
      let valText = c.discount_value;
      if (c.discount_type === 'PERCENT' && c.max_discount_amount) valText += `% (max ${c.max_discount_amount})`;
      tdVal.textContent = valText;
      tr.appendChild(tdVal);

      // Validity
      const tdValidity = document.createElement('td');
      try {
        const start = new Date(c.start_date).toLocaleString();
        const end = new Date(c.end_date).toLocaleString();
        tdValidity.textContent = `${start} — ${end}`;
      } catch(e){ tdValidity.textContent = c.start_date + ' — ' + c.end_date; }
      tr.appendChild(tdValidity);

      // Eligibility (preformatted)
      const tdElig = document.createElement('td');
      const pre = document.createElement('pre'); pre.className='pre';
      pre.textContent = JSON.stringify(c.eligibility || {}, null, 2);
      tdElig.appendChild(pre);
      tr.appendChild(tdElig);

      // Actions
      const tdAction = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'btn small';
      btn.textContent = 'Mark Used (demo)';
      btn.addEventListener('click', () => markUsed(c.code));
      tdAction.appendChild(btn);
      tr.appendChild(tdAction);

      return tr;
    }

    // Load coupons from backend
    async function loadCoupons(){
      body.innerHTML = '';
      try {
        const res = await window.api.apiGet('/coupons');
        const coupons = res.coupons || [];
        if (!coupons.length) {
          const empty = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 6;
          td.className='hint';
          td.textContent = 'No coupons found.';
          empty.appendChild(td);
          body.appendChild(empty);
          return;
        }
        coupons.forEach(c => body.appendChild(renderRow(c)));
      } catch (err) {
        showMsg('error', err.message || 'Failed to load coupons');
      }
    }

    // Mark usage: increments usage count for demo user
    async function markUsed(code) {
      const demoUser = 'demo-user-1';
      if (!confirm(`Mark coupon ${code} as used by demo user (${demoUser})?`)) return;
      try {
        await window.api.apiPost(`/coupons/use/${encodeURIComponent(code)}`, { userId: demoUser });
        showMsg('success', `Marked ${code} used for ${demoUser}`);
        await loadCoupons();
      } catch (err) {
        showMsg('error', err.message || 'Failed to mark used');
      }
    }

    // initial load
    loadCoupons();
  </script>

  <!-- Vercel Speed Insights -->
  <script>
    window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
  </script>
  <script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>
